{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ exam.name }} - Online Examination</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>

<body class="bg-[#fcfaf7] font-rubik">
<div class="min-h-screen flex flex-col" id="exam-container">
    <!-- Header -->
    <header class="bg-white shadow-md border-b border-[#e8decf]">
        <div class="container mx-auto px-4 py-2 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-bold text-[#1c170d]">{{ exam.name }}</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-sm text-[#616161]">Language:</span>
                    <select id="languageSelect" class="border border-[#e8decf] rounded px-2 py-1 text-sm">
                        <option value="English" {% if language == 'English' %}selected{% endif %}>English</option>
                        <option value="Hindi" {% if language == 'Hindi' %}selected{% endif %}>हिंदी</option>
                    </select>
                </div>
                <div class="text-sm text-[#616161]">
                    Time: <span id="timer" class="font-bold text-[#f2960d]">{{ duration_minutes }}:00</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 flex flex-col lg:flex-row gap-4">
        <!-- Question Area -->
        <div class="flex-grow bg-white rounded-lg shadow p-6 flex flex-col">
            <div class="flex-grow">
                <!-- Student Info -->
                <div class="flex items-start gap-4 mb-6 pb-4 border-b border-[#e8decf]">
                    <div class="p-3 bg-[#f5ede8] rounded-full">
                        <span class="material-symbols-outlined text-3xl text-[#616161]">person</span>
                    </div>
                    <div class="grid grid-cols-[max-content_1fr] gap-x-4 gap-y-1 text-sm">
                        <span class="font-medium text-[#616161]">Candidate Name</span>
                        <span class="font-bold text-[#1c170d]">
                            {% if request.user.studentprofile.first_name and request.user.studentprofile.last_name %}
                                {{ request.user.studentprofile.first_name }} {{ request.user.studentprofile.last_name }}
                            {% else %}
                                {{ request.user.username }}
                            {% endif %}
                        </span>
                        <span class="font-medium text-[#616161]">Exam Name</span>
                        <span class="font-bold text-[#1c170d]">{{ exam.name }}</span>
                        <span class="font-medium text-[#616161]">Total Questions</span>
                        <span class="font-bold text-[#1c170d]">{{ questions|length }}</span>
                        <span class="font-medium text-[#616161]">Remaining Time</span>
                        <span class="font-bold text-white bg-[#f2960d] px-2 py-1 rounded" id="remainingTime">{{ duration_minutes }}:00</span>
                    </div>
                </div>

                <!-- Question Content -->
                <div class="mb-6" id="questionContainer">
                    {% if questions %}
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-[#1c170d]" id="questionTitle">Question 1:</h2>
                            <button class="flex items-center gap-2 text-[#f2960d]" onclick="changeLanguage()">
                                View in:
                                <select id="questionLanguageSelect" class="border border-[#e8decf] bg-white rounded text-sm p-1">
                                    <option value="English" {% if language == 'English' %}selected{% endif %}>English</option>
                                    <option value="Hindi" {% if language == 'Hindi' %}selected{% endif %}>हिंदी</option>
                                </select>
                            </button>
                        </div>
                        <div class="space-y-4 text-base" id="questionContent">
                            <!-- Question content will be loaded here -->
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <p class="text-[#616161]">No questions available for this exam.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="mt-auto pt-6 border-t border-[#e8decf]">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="flex flex-wrap gap-2">
                        <button class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow-sm hover:opacity-90 transition-opacity text-sm" onclick="saveAnswer()">SAVE & NEXT</button>
                        <button class="px-4 py-2 bg-gray-200 text-[#1c170d] font-semibold rounded-md shadow-sm hover:opacity-90 transition-opacity text-sm" onclick="clearAnswer()">CLEAR</button>
                        <button class="px-4 py-2 bg-orange-500 text-white font-semibold rounded-md shadow-sm hover:opacity-90 transition-opacity text-sm" onclick="markForReview()">SAVE & MARK FOR REVIEW</button>
                        <button class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:opacity-90 transition-opacity text-sm" onclick="markForReviewAndNext()">MARK FOR REVIEW & NEXT</button>
                    </div>
                    <div class="flex gap-2">
                        <button class="px-4 py-2 bg-gray-200 text-[#1c170d] font-semibold rounded-md shadow-sm hover:opacity-90 transition-opacity text-sm" onclick="previousQuestion()">&lt;&lt; BACK</button>
                        <button class="px-4 py-2 bg-gray-200 text-[#1c170d] font-semibold rounded-md shadow-sm hover:opacity-90 transition-opacity text-sm" onclick="nextQuestion()">NEXT &gt;&gt;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Palette -->
        <div class="w-full lg:w-80 lg:flex-shrink-0 bg-white rounded-lg shadow p-4 flex flex-col">
            <div class="flex-grow overflow-y-auto">
                <!-- Legend -->
                <div class="grid grid-cols-2 gap-x-4 gap-y-3 mb-4 text-xs">
                    <div class="flex items-center gap-2">
                        <span class="w-7 h-7 flex items-center justify-center font-bold bg-gray-300 rounded-md">99</span>
                        <span>Not Visited</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-7 h-7 flex items-center justify-center font-bold text-white bg-red-600 rounded-md">1</span>
                        <span>Not Answered</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-7 h-7 flex items-center justify-center font-bold text-white bg-green-600 rounded-md">0</span>
                        <span>Answered</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-7 h-7 flex items-center justify-center font-bold text-white bg-purple-600 rounded-full">0</span>
                        <span>Marked for Review</span>
                    </div>
                    <div class="col-span-2 flex items-center gap-2">
                        <span class="relative w-7 h-7 flex items-center justify-center font-bold text-white bg-purple-600 rounded-full">
                            0
                            <span class="material-symbols-outlined text-base absolute -bottom-1 -right-1 bg-white rounded-full text-green-600">check_circle</span>
                        </span>
                        <div>
                            <span>Answered & Marked for Review</span>
                            <span class="block text-[#616161]">(will be considered for evaluation)</span>
                        </div>
                    </div>
                </div>

                <!-- Question Grid -->
                <div class="border-t border-[#e8decf] pt-4">
                    <h3 class="font-bold mb-2 text-[#1c170d]">Questions</h3>
                    <div class="grid grid-cols-7 gap-1.5 text-center" id="questionGrid">
                        <!-- Question numbers will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="mt-auto pt-4 border-t border-[#e8decf]">
                <button class="w-full px-4 py-2 bg-green-600 text-white font-bold rounded-md shadow-sm hover:opacity-90 transition-opacity text-lg" onclick="showSummaryModal()">SUBMIT</button>
            </div>
        </div>
    </main>
</div>

<!-- Attempt Summary Modal -->
<div id="summaryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-[#1c170d] mb-4">Exam Summary</h2>
            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-[#f5ede8] p-4 rounded-lg">
                        <p class="text-sm text-[#616161]">Total Questions</p>
                        <p class="text-2xl font-bold text-[#1c170d]" id="summaryTotalQuestions">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-[#616161]">Answered</p>
                        <p class="text-2xl font-bold text-green-600" id="summaryAnswered">0</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg">
                        <p class="text-sm text-[#616161]">Not Answered</p>
                        <p class="text-2xl font-bold text-red-600" id="summaryNotAnswered">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm text-[#616161]">Marked for Review</p>
                        <p class="text-2xl font-bold text-purple-600" id="summaryMarked">0</p>
                    </div>
                </div>
                <div class="border-t border-[#e8decf] pt-4">
                    <p class="text-sm font-medium text-[#616161] mb-2">Question Status:</p>
                    <div id="questionStatusList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSummaryModal()" class="flex-1 px-4 py-2 bg-gray-200 text-[#1c170d] font-semibold rounded-md hover:opacity-90">Cancel</button>
                <button onclick="confirmSubmit()" class="flex-1 px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:opacity-90">Confirm Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Exam data
    const examData = {
        questions: [],
        currentQuestion: 0,
        answers: {},
        markedForReview: new Set(),
        timeRemaining: {{ duration_minutes }} * 60, // in seconds
        language: '{{ language }}',
        timeSpent: {}, // Track time spent per question
        questionStartTime: null,
        examStartTime: Date.now(),
        timerInterval: null
    };
    
    // Parse questions from JSON
    try {
        examData.questions = {{ questions_json|safe }};
    } catch (e) {
        console.error('Error parsing questions:', e);
        examData.questions = [];
    }

    // Initialize exam
    document.addEventListener('DOMContentLoaded', function() {
        initializeExam();
        startTimer();
        
        // Initialize time tracking for first question
        examData.questionStartTime = Date.now();
        
        // Auto-save answer on input change
        setupAutoSave();
    });
    
    // Track time when leaving a question
    function trackTimeSpent(questionKey) {
        if (examData.questionStartTime && questionKey) {
            const timeSpent = Math.floor((Date.now() - examData.questionStartTime) / 1000);
            if (!examData.timeSpent[questionKey]) {
                examData.timeSpent[questionKey] = 0;
            }
            examData.timeSpent[questionKey] += timeSpent;
        }
    }

    function initializeExam() {
        // Reset any prior state to avoid pre-marked questions
        examData.answers = {};
        examData.markedForReview = new Set();
        examData.currentQuestion = 0;
        if (examData.questions.length > 0) {
            displayQuestion(0);
        }
    }

    function displayQuestion(questionIndex) {
        if (questionIndex < 0 || questionIndex >= examData.questions.length) return;
        
        // Track time spent on previous question
        if (examData.currentQuestion >= 0 && examData.currentQuestion < examData.questions.length) {
            const prevQuestion = examData.questions[examData.currentQuestion];
            trackTimeSpent(prevQuestion.uid || prevQuestion.id);
        }
        
        examData.currentQuestion = questionIndex;
        const question = examData.questions[questionIndex];
        
        // Update question title
        document.getElementById('questionTitle').textContent = `Question ${questionIndex + 1}:`;
        
        // Update question content based on type
        const contentDiv = document.getElementById('questionContent');
        contentDiv.innerHTML = generateQuestionHTML(question);
        
        // Start tracking time for new question
        examData.questionStartTime = Date.now();
        
        // Update question grid
        updateQuestionGrid();
        
        // Restore answer if exists
        restoreAnswer(question);
    }
    
    function restoreAnswer(question) {
        if (question.type === 'mcq') {
            const savedAnswer = examData.answers[question.uid || question.id];
            if (savedAnswer) {
                const radio = document.querySelector(`input[name="answer_${question.uid || question.id}"][value="${savedAnswer}"]`);
                if (radio) radio.checked = true;
            }
        } else if (question.type === 'msq') {
            const savedAnswer = examData.answers[question.uid || question.id];
            if (savedAnswer) {
                const selected = savedAnswer.split(',');
                selected.forEach(opt => {
                    const checkbox = document.querySelector(`input[name="answer_${question.uid || question.id}"][value="${opt}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        } else if (question.type === 'numerical') {
            const savedAnswer = examData.answers[question.uid || question.id];
            if (savedAnswer) {
                const input = document.querySelector(`input[name="answer_${question.uid || question.id}"]`);
                if (input) input.value = savedAnswer;
            }
        }
    }
    
    function setupAutoSave() {
        // This will be called after each question is displayed
        document.addEventListener('change', function(e) {
            if (e.target.matches('input[type="radio"], input[type="checkbox"], input[type="number"]')) {
                const questionKey = e.target.name.replace('answer_', '');
                const question = examData.questions.find(q => (q.uid || String(q.id)) == questionKey);
                if (question) {
                    const answer = getCurrentAnswer(question);
                    if (isValueAnswered(question, answer)) {
                        examData.answers[question.uid || question.id] = answer;
                    } else {
                        delete examData.answers[question.uid || question.id];
                    }
                    updateQuestionGrid();
                }
            }
        });
    }

    function generateQuestionHTML(question) {
        let html = `<p class="text-[#1c170d] mb-4">${question.text}</p>`;
        
        if (question.image && question.image.url) {
            html += `<img src="${question.image.url}" alt="Question Image" class="mb-4 max-w-full h-auto rounded-lg shadow-sm">`;
        } else if (question.image && typeof question.image === 'string') {
            html += `<img src="${question.image}" alt="Question Image" class="mb-4 max-w-full h-auto rounded-lg shadow-sm">`;
        }
        
        if (question.type === 'mcq') {
            html += '<div class="space-y-3"><p class="font-medium text-[#1c170d] mb-2">Options:</p>';
            Object.entries(question.options).forEach(([key, value]) => {
                const isChecked = examData.answers[question.uid || question.id] === key ? 'checked' : '';
                html += `
                    <label class="flex items-center gap-3 p-3 border-2 border-[#e8decf] rounded-lg cursor-pointer hover:bg-[#f5ede8] transition-colors ${isChecked ? 'bg-[#f5ede8] border-[#f2960d]' : ''}">
                        <input class="form-radio text-[#f2960d] focus:ring-[#f2960d] w-5 h-5" name="answer_${question.uid || question.id}" type="radio" value="${key}" ${isChecked}>
                        <span class="text-[#1c170d] flex-1">${key}. ${value}</span>
                    </label>
                `;
            });
            html += '</div>';
        } else if (question.type === 'msq') {
            html += '<div class="space-y-3"><p class="font-medium text-[#1c170d] mb-2">Options (Select one or more):</p>';
            Object.entries(question.options).forEach(([key, value]) => {
                const savedAnswer = examData.answers[question.uid || question.id];
                const isChecked = savedAnswer && savedAnswer.split(',').includes(key) ? 'checked' : '';
                html += `
                    <label class="flex items-center gap-3 p-3 border-2 border-[#e8decf] rounded-lg cursor-pointer hover:bg-[#f5ede8] transition-colors ${isChecked ? 'bg-[#f5ede8] border-[#f2960d]' : ''}">
                        <input class="form-checkbox text-[#f2960d] focus:ring-[#f2960d] w-5 h-5" name="answer_${question.uid || question.id}" type="checkbox" value="${key}" ${isChecked}>
                        <span class="text-[#1c170d] flex-1">${key}. ${value}</span>
                    </label>
                `;
            });
            html += '</div>';
        } else if (question.type === 'numerical') {
            const value = examData.answers[question.uid || question.id] || '';
            html += `
                <div class="space-y-3">
                    <p class="font-medium text-[#1c170d] mb-2">Enter your answer:</p>
                    <input type="number" step="any" name="answer_${question.uid || question.id}" value="${value}" 
                           class="w-full p-3 border-2 border-[#e8decf] rounded-lg focus:ring-[#f2960d] focus:border-[#f2960d] text-lg" 
                           placeholder="Enter numerical answer">
                </div>
            `;
        }
        
        return html;
    }

    function isValueAnswered(question, value) {
        const saved = value;
        if (saved === null || saved === undefined) return false;
        if (question.type === 'msq') {
            if (Array.isArray(saved)) return saved.filter(Boolean).length > 0;
            if (typeof saved === 'string') return saved.split(',').filter(s => s && s.trim() !== '').length > 0;
            return false;
        }
        if (question.type === 'numerical') {
            // Treat empty string or NaN as unanswered
            if (String(saved).trim() === '') return false;
            return true;
        }
        if (question.type === 'mcq') {
            return typeof saved === 'string' && saved.trim() !== '';
        }
        return false;
    }

    function isQuestionAnswered(question) {
        return isValueAnswered(question, examData.answers[question.uid || question.id]);
    }

    function generateQuestionGrid() {
        const grid = document.getElementById('questionGrid');
        grid.innerHTML = '';
        
        for (let i = 0; i < examData.questions.length; i++) {
            const button = document.createElement('button');
            button.className = 'w-8 h-8 flex items-center justify-center rounded-md text-sm font-medium';
            button.textContent = String(i + 1).padStart(2, '0');
            button.onclick = () => displayQuestion(i);
            
            // Set button color based on status
            const hasAnswer = isQuestionAnswered(examData.questions[i]);
            const isMarked = examData.markedForReview instanceof Set && examData.markedForReview.has((examData.questions[i].uid || examData.questions[i].id));
            
            if (i === examData.currentQuestion) {
                button.className += ' bg-blue-600 text-white ring-2 ring-blue-300';
            } else if (hasAnswer && isMarked) {
                button.className += ' bg-purple-600 text-white relative';
                const checkIcon = document.createElement('span');
                checkIcon.className = 'absolute -bottom-1 -right-1 text-xs';
                checkIcon.innerHTML = '✓';
                button.appendChild(checkIcon);
            } else if (hasAnswer) {
                button.className += ' bg-green-600 text-white';
            } else if (isMarked) {
                button.className += ' bg-purple-600 text-white rounded-full';
            } else {
                button.className += ' bg-gray-300 text-gray-700';
            }
            
            grid.appendChild(button);
        }
    }

    function updateQuestionGrid() {
        generateQuestionGrid();
    }

    function nextQuestion() {
        if (examData.currentQuestion < examData.questions.length - 1) {
            displayQuestion(examData.currentQuestion + 1);
        }
    }

    function previousQuestion() {
        if (examData.currentQuestion > 0) {
            displayQuestion(examData.currentQuestion - 1);
        }
    }

    function saveAnswer() {
        const question = examData.questions[examData.currentQuestion];
        const answer = getCurrentAnswer(question);
        
        if (isValueAnswered(question, answer)) {
            examData.answers[question.uid || question.id] = answer;
        } else {
            delete examData.answers[question.uid || question.id];
        }
        
        trackTimeSpent(question.uid || question.id);
        updateQuestionGrid();
        nextQuestion();
    }

    function getCurrentAnswer(question) {
        if (question.type === 'mcq') {
            const selected = document.querySelector(`input[name="answer_${question.uid || question.id}"]:checked`);
            return selected ? selected.value : null;
        } else if (question.type === 'msq') {
            const selected = Array.from(document.querySelectorAll(`input[name="answer_${question.uid || question.id}"]:checked`));
            return selected.length > 0 ? selected.map(input => input.value).join(',') : null;
        } else if (question.type === 'numerical') {
            const input = document.querySelector(`input[name="answer_${question.uid || question.id}"]`);
            return input ? input.value : null;
        }
        return null;
    }

    function clearAnswer() {
        const question = examData.questions[examData.currentQuestion];
        const inputs = document.querySelectorAll(`input[name="answer_${question.uid || question.id}"]`);
        inputs.forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
        delete examData.answers[question.uid || question.id];
        updateQuestionGrid();
    }


    function markForReview() {
        const question = examData.questions[examData.currentQuestion];
        const answer = getCurrentAnswer(question);
        if (isValueAnswered(question, answer)) {
            examData.answers[question.uid || question.id] = answer;
        } else {
            delete examData.answers[question.uid || question.id];
        }
        examData.markedForReview.add(question.uid || question.id);
        updateQuestionGrid();
    }
    
    function markForReviewAndNext() {
        markForReview();
        const question = examData.questions[examData.currentQuestion];
        trackTimeSpent(question.uid || question.id);
        nextQuestion();
    }

    function changeLanguage() {
        const selectedLanguage = document.getElementById('questionLanguageSelect').value;
        examData.language = selectedLanguage;
        // Here you would typically reload the question content in the selected language
        // For now, we'll just update the main language selector
        document.getElementById('languageSelect').value = selectedLanguage;
    }

    function startTimer() {
        const timerElement = document.getElementById('remainingTime');
        
        examData.timerInterval = setInterval(() => {
            examData.timeRemaining--;
            
            const minutes = Math.floor(examData.timeRemaining / 60);
            const seconds = examData.timeRemaining % 60;
            
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (examData.timeRemaining <= 0) {
                clearInterval(examData.timerInterval);
                confirmSubmit();
            }
        }, 1000);
    }
    
    function showSummaryModal() {
        // Track time on current question
        const question = examData.questions[examData.currentQuestion];
        trackTimeSpent(question.uid || question.id);
        
        // Calculate summary
        const totalQuestions = examData.questions.length;
        const answered = examData.questions.reduce((acc, q) => acc + (isQuestionAnswered(q) ? 1 : 0), 0);
        const notAnswered = totalQuestions - answered;
        const markedCount = examData.markedForReview.size;
        
        // Update modal content
        document.getElementById('summaryTotalQuestions').textContent = totalQuestions;
        document.getElementById('summaryAnswered').textContent = answered;
        document.getElementById('summaryNotAnswered').textContent = notAnswered;
        document.getElementById('summaryMarked').textContent = markedCount;
        
        // Generate question status list
        const statusList = document.getElementById('questionStatusList');
        statusList.innerHTML = '';
        examData.questions.forEach((q, index) => {
            const hasAnswer = isQuestionAnswered(q);
            const isMarked = examData.markedForReview.has(q.uid || q.id);
            const statusDiv = document.createElement('div');
            statusDiv.className = 'flex items-center justify-between p-2 rounded ' + 
                (hasAnswer ? 'bg-green-50' : 'bg-red-50');
            
            let statusText = `Q${index + 1}: `;
            if (hasAnswer && isMarked) {
                statusText += 'Answered & Marked for Review';
            } else if (hasAnswer) {
                statusText += 'Answered';
            } else if (isMarked) {
                statusText += 'Marked for Review (Not Answered)';
            } else {
                statusText += 'Not Answered';
            }
            
            statusDiv.innerHTML = `<span class="text-sm">${statusText}</span>`;
            statusList.appendChild(statusDiv);
        });
        
        // Show modal
        document.getElementById('summaryModal').classList.remove('hidden');
    }
    
    function closeSummaryModal() {
        document.getElementById('summaryModal').classList.add('hidden');
    }
    
    async function confirmSubmit() {
        // Track time on current question
        const question = examData.questions[examData.currentQuestion];
        trackTimeSpent(question.uid || question.id);
        
        closeSummaryModal();
        
        // Calculate total time taken
        const totalTime = Math.floor((Date.now() - examData.examStartTime) / 1000);
        
        // Prepare submission data
        const submissionData = {
            answers: examData.answers,
            time_spent: examData.timeSpent,
            start_time: examData.examStartTime,
            total_time: totalTime
        };
        
        try {
            const response = await fetch(`/exam/{{ exam.id }}/submit/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(submissionData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                clearInterval(examData.timerInterval);
                window.location.href = result.redirect_url;
            } else {
                alert('Error submitting exam: ' + (result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Submission error:', error);
            alert('Error submitting exam. Please try again.');
        }
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Language selector change handler
    document.getElementById('languageSelect').addEventListener('change', function() {
        examData.language = this.value;
        // Reload the page with new language
        const url = new URL(window.location);
        url.searchParams.set('language', this.value);
        window.location.href = url.toString();
    });
</script>
</body>
</html>