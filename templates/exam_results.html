{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ exam.name }} - Results</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen font-inter">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ exam.name }}</h1>
                    <p class="text-gray-600">Exam Results & Detailed Analysis</p>
                </div>
                <div class="flex gap-3">
                    <a href="/dashboard/" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Score Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-blue-100 text-sm font-medium">Score</span>
                    <span class="material-symbols-outlined text-2xl">score</span>
                </div>
                <p class="text-4xl font-bold mb-1">{{ attempt.score|floatformat:1 }}</p>
                <p class="text-blue-100 text-sm">out of {{ attempt.total_marks|floatformat:1 }}</p>
            </div>
            
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-green-100 text-sm font-medium">Percentage</span>
                    <span class="material-symbols-outlined text-2xl">percent</span>
                </div>
                <p class="text-4xl font-bold mb-1">{{ attempt.percentage|floatformat:1 }}%</p>
                <p class="text-green-100 text-sm">Overall Performance</p>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-purple-100 text-sm font-medium">Correct</span>
                    <span class="material-symbols-outlined text-2xl">check_circle</span>
                </div>
                <p class="text-4xl font-bold mb-1">{{ correct_count }}</p>
                <p class="text-purple-100 text-sm">out of {{ total_questions }} questions</p>
            </div>
            
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-orange-100 text-sm font-medium">Time Taken</span>
                    <span class="material-symbols-outlined text-2xl">schedule</span>
                </div>
                <p class="text-4xl font-bold mb-1">{{ attempt.time_taken|time:"H:i" }}</p>
                <p class="text-orange-100 text-sm">{{ avg_time_per_question }}s avg/question</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Performance Chart -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Performance Overview</h2>
                <canvas id="performanceChart" class="max-h-64"></canvas>
            </div>
            
            <!-- Quick Stats -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Quick Stats</h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">Answered</span>
                        <span class="text-lg font-bold text-green-600">{{ answered_count }}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-red-50 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">Incorrect</span>
                        <span class="text-lg font-bold text-red-600">{{ incorrect_count }}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">Unanswered</span>
                        <span class="text-lg font-bold text-yellow-600">{{ total_questions|add:"-"|add:answered_count }}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">Accuracy</span>
                        <span class="text-lg font-bold text-blue-600">
                            {% if answered_count > 0 %}
                                {% widthratio correct_count answered_count 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topic Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Topics Covered -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Topics Covered</h2>
                <div class="space-y-3 max-h-96 overflow-y-auto">
                    {% for topic, stats in topic_stats.items %}
                    <div class="p-4 border border-gray-200 rounded-lg hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-900">{{ topic }}</h3>
                            <span class="text-sm font-medium text-gray-600">{{ stats.correct }}/{{ stats.total }}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                            {% widthratio stats.correct stats.total 100 as accuracy %}
                            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full" style="width: {% if accuracy > 100 %}100{% else %}{{ accuracy }}{% endif %}%"></div>
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-600">
                            <span>Accuracy: {% if stats.total > 0 %}{% widthratio stats.correct stats.total 100 %}%{% else %}0%{% endif %}</span>
                            <span>Avg Time: {{ stats.time_spent|floatformat:0 }}s</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Average Time Analysis -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Time Spent Analysis</h2>
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-100">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">Average Time per Question</span>
                            <span class="text-2xl font-bold text-blue-600">{{ avg_time_per_question }}s</span>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">Based on your response patterns</p>
                    </div>
                    
                    <div class="space-y-3">
                        <h3 class="font-semibold text-gray-900 text-sm">Time Distribution by Topic:</h3>
                        {% for topic, stats in topic_stats.items %}
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-700">{{ topic }}</span>
                            <div class="flex items-center gap-2">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    {% with total_time=topic_stats|length|default:1 %}
                                    <div class="bg-gradient-to-r from-purple-400 to-pink-500 h-2 rounded-full" style="width: {% widthratio stats.time_spent 300 100 %}%"></div>
                                    {% endwith %}
                                </div>
                                <span class="text-gray-600 font-medium w-12 text-right">{{ stats.time_spent|floatformat:0 }}s</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Weak Topics & Suggestions -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Weak Topics -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex items-center gap-2 mb-4">
                    <span class="material-symbols-outlined text-red-500">warning</span>
                    <h2 class="text-xl font-bold text-gray-900">Weaker Topics</h2>
                </div>
                {% if weak_topics %}
                <div class="space-y-3">
                    {% for weak in weak_topics %}
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-900">{{ weak.topic }}</h3>
                            <span class="text-sm font-bold text-red-600">{{ weak.accuracy }}%</span>
                        </div>
                        <p class="text-xs text-gray-600">Only {{ weak.correct }} out of {{ weak.total }} questions correct</p>
                        <div class="mt-2 p-2 bg-white rounded border border-red-100">
                            <p class="text-xs text-gray-700">
                                <strong>Suggestion:</strong> Review fundamental concepts in {{ weak.topic }} and practice more questions in this area.
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                    <span class="material-symbols-outlined text-green-500 text-4xl mb-2">check_circle</span>
                    <p class="text-green-700 font-medium">Great job! No weak topics identified.</p>
                </div>
                {% endif %}
            </div>

            <!-- Missed Topics -->
            <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <div class="flex items-center gap-2 mb-4">
                    <span class="material-symbols-outlined text-yellow-500">pending</span>
                    <h2 class="text-xl font-bold text-gray-900">Missed Topics</h2>
                </div>
                {% if missed_topics %}
                <div class="space-y-3">
                    {% for missed in missed_topics %}
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-900">{{ missed.topic }}</h3>
                            <span class="text-sm font-bold text-yellow-600">{{ missed.unanswered }} unanswered</span>
                        </div>
                        <p class="text-xs text-gray-600">You missed {{ missed.unanswered }} out of {{ missed.total }} questions in this topic</p>
                        <div class="mt-2 p-2 bg-white rounded border border-yellow-100">
                            <p class="text-xs text-gray-700">
                                <strong>Suggestion:</strong> Complete the remaining questions in {{ missed.topic }} to improve your overall score.
                            </p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
                    <span class="material-symbols-outlined text-green-500 text-4xl mb-2">check_circle</span>
                    <p class="text-green-700 font-medium">Excellent! No topics were missed.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Question-wise Breakdown -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Question-wise Breakdown</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Q.No</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Type</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Topic</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Your Answer</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700">Status</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700">Marks</th>
                            <th class="text-center py-3 px-4 font-semibold text-gray-700">Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for qa in question_answers %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50">
                            <td class="py-3 px-4 font-medium text-gray-900">{{ qa.question_id }}</td>
                            <td class="py-3 px-4 text-gray-600 uppercase">{{ qa.question_type }}</td>
                            <td class="py-3 px-4 text-gray-600">{{ qa.topic|default:"General" }}</td>
                            <td class="py-3 px-4 text-gray-700">
                                {% if qa.user_answer %}
                                    {{ qa.user_answer }}
                                {% else %}
                                    <span class="text-gray-400">Not Answered</span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 text-center">
                                {% if qa.is_correct %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <span class="material-symbols-outlined text-sm mr-1">check_circle</span>Correct
                                    </span>
                                {% elif qa.user_answer %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        <span class="material-symbols-outlined text-sm mr-1">cancel</span>Incorrect
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        <span class="material-symbols-outlined text-sm mr-1">help</span>Unanswered
                                    </span>
                                {% endif %}
                            </td>
                            <td class="py-3 px-4 text-center font-semibold {% if qa.marks_obtained > 0 %}text-green-600{% elif qa.marks_obtained < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                {{ qa.marks_obtained|floatformat:1 }}
                            </td>
                            <td class="py-3 px-4 text-center text-gray-600">{{ qa.time_spent_seconds }}s</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Performance Chart
        const ctx = document.getElementById('performanceChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Correct', 'Incorrect', 'Unanswered'],
                    datasets: [{
                        data: [{{ correct_count }}, {{ incorrect_count }}, {{ total_questions|add:"-"|add:answered_count }}],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(234, 179, 8, 0.8)'
                        ],
                        borderColor: [
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)',
                            'rgb(234, 179, 8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>

